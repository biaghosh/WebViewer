{% extends 'layout.html' %}
{% block content %}
<!-- page only css/js-->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/nano.min.css" />
<!-- FontAwesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<!-- animate -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

<script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.es5.min.js"></script>
<style>
    .row {
        margin-top: 10px;
    }

    .cust-full {
        background-color: #0F71F2;
        color: white;
        border: none;
        padding: 6px 12px;
        font-size: 12px;
        cursor: pointer;
        border-radius: 4px;
        transition: background-color 0.3s;
    }

    .cust-full:hover {
        background-color: #0F71F2;

    }

    .cust-full:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    #arrowControls button {
        margin: 0 4px;
    }

    ::backdrop {
        background-color: white;
    }

    i.icon {
        display: inline-block;
        /* chrome-fix */
    }


    @-webkit-keyframes rotation {
        from {
            -webkit-transform: rotate(0deg);
        }

        to {
            -webkit-transform: rotate(359deg);
        }
    }

    @-moz-keyframes rotation {
        from {
            -moz-transform: rotate(0deg);
        }

        to {
            -moz-transform: rotate(359deg);
        }
    }

    @-o-keyframes rotation {
        from {
            -o-transform: rotate(0deg);
        }

        to {
            -o-transform: rotate(359deg);
        }
    }

    @keyframes rotation {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(359deg);
        }
    }

    .overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 2;
        cursor: pointer;
    }

    .always-on-top {
        z-index: 100000 !important;
    }


    @keyframes fadeIn {
        0% {
            opacity: 0;
        }

        100% {
            opacity: 1;
        }
    }

    #toolsCol {
        margin-right: 10px;
        /* Add some margin to the right side */
    }

    .card-header {
        padding: 0.5rem 1.25rem;
        /* Adjust the padding as needed */
    }

    .nav-tabs {
        flex-direction: column;
    }



    .tab-pane {
        padding: 1rem;
        /* Adjust the padding as needed */
    }

    .tools-wrapper {
        position: relative;
    }

    .toggle-btn {
        position: absolute;
        top: 50%;
        right: 0;
        transform: translate(0, -50%);
        background: transparent;
        border: none;
        padding: 0;
        margin: 0;
        z-index: 9999;
        cursor: pointer;
    }

    .toggle-icon {
        width: 20px;
        height: 3px;
        background-color: #000;
        margin: 4px 0;
        transition: transform 0.3s ease;
    }

    .tools-hidden #toolsCol {
        display: none;
    }

    .tools-hidden .toggle-icon {
        transform: rotate(90deg);
    }

    #mySidebar {
        height: 90%;
        width: 400px;
        position: fixed;
        left: 0;
        top: 70px;
        z-index: 1;
        background-color: #ffffff;
        overflow-x: hidden;
        transition: transform 0.5s;
        transform: translateX(-86%);
        padding-top: 60px;
    }

    #mySidebar.show {
        transform: translateX(0);
    }


    .my-container {
        height: calc(100vh - 50px);
        padding: 20px;
        top: 50px;
        position: relative;
        margin-left: 0; /* Default when sidebar is hidden */
        transition: margin-left 0.5s;
    }

    #mySidebar.show ~ .my-container {
        margin-left: 400px; /* Adjust according to sidebar width */
    }

    #mySidebar a {
        padding: 8px 8px 8px 32px;
        text-decoration: none;
        display: block;
        transition: 0.3s;
    }

    #mySidebar a:hover {
        color: #0F71F2;
    }

    #mySidebar .closebtn {
        position: absolute;
        color: #0F71F2;
        top: 0;
        right: 2px;
        font-size: 36px;
        margin-left: 75px;
    }

    .my-container {
        height: calc(100vh - 50px);
        padding: 20px;
        top: 50px;
        position: relative;
    }



    /* Custmize style button */
    .btn-custom {
        padding: 5px 15px;
        /* Increase filling to make button bigger */
        font-size: 14px;
        /* Increase font */
        border-radius: 25px;
        /* border-radius */
        border: none;
        /* Remove border */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        /* Add shadow */
        transition: all 0.2s ease;
        /* Transition effect */
    }

    /* Adjust color of Measure */
    .btn-measure {
        background-color: #17a2b8;
        color: white;
    }

    /* Adjust color of Clear */
    .btn-clear {
        background-color: #dc3545;
        color: white;
    }

    /* Mouse hover effect */
    .btn-custom:hover {
        transform: translateY(-2px);
        /* Move up slightly */
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    }

    /* Style of banned button */
    .btn-custom:disabled {
        background-color: #cccccc;
        color: #666666;
        box-shadow: none;
        cursor: not-allowed;
    }

    .card-body .form-group {
        margin-right: 100px !important;
    }

    .card-body dt {
        font-weight: bold !important;
    }

    .small {
        font-size: 0.8rem;
    }

    .mb-0 {
        margin-bottom: 0;
    }

    #myTabNav .nav-link {
        font-weight: bold;
    }

    .form-group label {
        font-weight: bold;
    }

    .card-header .nav-link {
        font-weight: bold;
    }

    .btn-icon {
        font-size: 14px;
        padding: 5px 10px;
    }

    .table-responsive {
        max-height: 300px;
        overflow-y: auto;
    }

    .tab-pane {
        padding: 20px;
    }

    .modal-content {
        border: 1px solid #ddd;
        border-radius: 5px;
    }

    .modal-body {
        padding: 15px;
    }

    .sticky-header th {
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
    }

    .file-selector {
        display: flex;
        align-items: center;
        width: 100%;
    }

    .file-choose-container {
        display: flex;
        align-items: center;
        flex-grow: 1;
    }

    .btn-primary:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: #fff;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .btn-secondary:hover {
        background-color: #5a6268;
    }

    .action-buttons {
        display: flex;
        justify-content: center;
        width: 100%;
    }

    .action-buttons button {
        margin: 0 10px;
    }

    .modal-title {
        font-weight: bold;
        font-size: 1.5rem;
    }

    .detail-section {
        margin-bottom: 1.5rem;
        font-size: 1rem;
    }

    .table-responsive {
        margin-top: 1rem;
    }

    .table {
        margin-bottom: 0;
    }

    .table-bordered {
        border: 1px solid #dee2e6;
    }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .thead-dark th {
        background-color: #343a40;
        color: #fff;
    }

    .close {
        font-size: 1.5rem;
        color: #000;
    }

    .close:hover,
    .close:focus {
        color: #000;
        text-decoration: none;
        opacity: 0.75;
    }
</style>

<div class="container-fluid" style="height: 100vh;">
        <div id="mySidebar" class="card mt-1 shadow">
            <!-- <button class="openbtn" onclick="toggleNav()">☰</button> -->
            <a href="javascript:void(0)" class="closebtn" onclick="toggleNav()">☰</a>
            <div class="card-header pt-1">
                <ul class="nav nav-tabs card-header-tabs flex-column">
                    <li id="tab1" class="nav-item">
                        <a id="imageTab" class="nav-link px-2" data-toggle="tab" href="#imageCard"><i
                                class="fas fa-tools "></i> Image Tools</a>
                    </li>

                    <li id="tab2" class="nav-item">
                        <a class="nav-link px-2" data-toggle="tab" href="#annCard"><i class="fas fa-comments"></i>
                            Annotations</a>
                    </li>

                    <li id="tab3" class="nav-item">
                        <a class="nav-link px-2" data-toggle="tab" href="#viewCard"><i class="fas fa-eye"></i>
                            Views</a>
                    </li>

                    <li id="tab4" class="nav-item">
                        <a class="nav-link px-2" data-toggle="tab" href="#maskCard"><i class="fas fa-crop"></i>
                            Masks</a>
                    </li>

                    <li id="tab5" class="nav-item">
                        <a class="nav-link px-2" data-toggle="tab" href="#exportCard"><i class="fas fa-file-export"></i>
                            Export</a>
                    </li>
                    <li id="tab7" class="nav-item">
                        <a class="nav-link px-2" data-toggle="tab" href="#fileCard"><i class="fas fa-file"></i>
                            Media & Files</a>
                    </li>

                    <li id="tab9" class="nav-item d-none">
                        <a class="nav-link px-2" data-toggle="tab" href="#settingsCard">Settings</a>
                    </li>
                </ul>
            </div>
            <div class="tab-content">
                <div id="imageCard" class="card-body tab-pane">
                    <form class="form-inline" onSubmit="return false;" style="margin-top: 10px;">
                        <div class="form-group col-12">
                            <div class="col-12 text-center bg-secondary text-white rounded"><b>2D</b></div>
                        </div>

                        <div class="form-group col-12">
                            <button id="measureBtn" type="button" class="btn btn-custom btn-measure mr-1"
                                disabled>Measure</button>
                            <button id="measureClearBtn" type="button" class="btn btn-custom btn-clear mr-1"
                                disabled>Clear</button>
                        </div>

                        <div class="form-group col-12">
                            <small class="mb-1 text-wrap" style="width: 100%;">Click twice in the XY plane
                                to display a measurement in µm.</small>
                        </div>


                        <div class="form-group col-12">
                            <input id="pixelBox" class="ml-2 form-check-input" type="checkbox" disabled>
                            <label class="form-check-label mr-1" for="pixelBox">Pixel Value</label>
                            <span id="pixelSpan" class="text-center"></span>
                        </div>
                        
                    </form>

                    <form class="form-inline" onSubmit="return false;" style="margin-top: 10px;">
                        <div class="form-group col-12" style="margin-top: 10px;">
                            <div class="col-12 text-center bg-secondary text-white rounded"><b>Shared</b></div>
                        </div>

                        <div class="form-group col-12" style="margin-top: 10px;">
                            <label for="threshold" class="mb-0 mr-1">Threshold</label>
                            <input type="range" id="threshold2D" min="0" max="3" step=".05" value="0.0">
                        </div>

                        <div class="form-group col-12">
                            <label class="form-label mt-1 mr-1">Background Color&nbsp;</label>
                            <div class="pickr" id="bg2"></div>
                        </div>
                        <div class="form-group col-12">
                            <label class="form-check-label mr-1" for="zoomCheckbox">Auto Zooming:
                                <i class="fas fa-info-circle d-none" data-toggle="popover" data-placement="top"
                                    title="Auto Zooming"
                                    data-content="The views will share the same view level"></i>&nbsp;</label>
                            <input class="form-check-input" type="checkbox" id="zoomCheckbox" checked>&nbsp;
                        </div>
                    </form>
                </div>

                <div id="annCard" class="card-body tab-pane">
                    <div class="form-group col-12 d-flex justify-content-between">
                        <button id="createAnnBtn" type="button" class="btn btn-secondary" disabled>Create
                            Annotations</button>
                        <button id="toggleAnnBtn" type="button" class="btn btn-secondary" disabled>Hide
                            Annotations</button>
                    </div>

                    <div class="form-group col-12">
                        <div style="overflow: scroll; max-height: 300px;">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th scope="col"></th>
                                        <th scope="col">Text</th>
                                        <th scope="col">Plane</th>
                                        <th scopr="col">Slice</th>
                                        <th scope="col">Instance</th>
                                        <th scope="col">Date</th>
                                        <th scope="col">User</th>
                                    </tr>
                                </thead>
                                <tbody id="annTbody">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="form-group col-12 d-flex align-items-center">
                        <label for="annFontNumber" style="margin-right: 10px;">Font Scaling</label>
                        <input id="annFontNumber" style="width: 150px;" class="form-control" type="number" min="0.5"
                            max="3" step=".25" value="1" disabled>
                    </div>

                    <!-- <div id="sliceDiv" class="form-group mb-2 d-flex align-items-center">
                        <label for="sliceInput" class="mb-0" style="margin-right: 10px;">Slice
                            Navigator:</label>
                        <input id="sliceInput" class="form-control" type="number" max="700"
                            disabled>
                    </div> -->
                </div>

                <div id="viewCard" class="card-body tab-pane">
                    <p>This will save the camera viewport, slice, and image type to be able to return to.</p>
                    <form onsubmit="return false;" class="form-inline">
                        <div class="form-row align-items-center">
                            <div class="col-auto">
                                <input id="viewName" type="text" class="form-control mb-2" placeholder="View name">
                            </div>
                            <div class="col-auto">
                                <button id="saveViewBtn" type="button" class="btn btn-secondary mb-2" disabled>Save
                                    View</button>
                            </div>
                        </div>
                    </form>

                    <div class="row">
                        <div class="col-12">
                            <label for="viewsTable">Go to View:</label>
                            <div class="table-responsive">
                                <table id="viewsTable" class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>View Name</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Rows will be dynamically added here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="maskCard" class="card-body tab-pane" style="padding-top: 10px; padding-bottom: 10px;">
                    <!-- <p>Draw a mask or series of masks on the xy plane for segmentation purposes or highlighting
                            areas of interest.
                            After entering a name, click in the scene and hold the mouse down to outline a feature.
                            Clicking the Finished button
                            will save the entries to the database and interpolate masks for slices without an entry.
                        </p> -->
                    <div class="row mx-2 my-1 p-1">
                        <label class="mt-2" for="maskInput">Mask Name</label>
                        <input id="maskInput" type="text" class="form-control col-7 mx-1" disabled>
                    </div>

                    <div class="row mx-2 my-1 p-1">
                        <button id="startMaskBtn" type="button" class="btn btn-success col-12" disabled>Start
                            Drawing</button>
                    </div>

                    <div class="row mx-2 my-1 p-1">
                        <label class="mt-2" for="maskInput">Start</label>
                        <input id="minSlice" type="text" class="form-control col-2 mx-1" disabled>
                        <label class="mt-2" for="maskInput">End</label>
                        <input id="maxSlice" type="text" class="form-control col-2 mx-1" disabled>
                        <label class="mt-2" for="totalSlices">Total</label>
                        <input id="totalSlices" type="text" class="form-control col-2 mx-1" disabled>
                    </div>

                    <div class="form-group form-check ml-2">
                        <input type="checkbox" class="form-check-input" id="copySliceBox">
                        <label class="form-check-label" for="copySliceBox">Copy to next slice</label>
                        <!-- <button id="eraseMaskBtn" type="button" class="btn btn-warning col-4" disabled>Erase
                            Current</button> -->
                        <!-- <button id="finishedMaskBtn" type="button" class="btn btn-primary col-4 ml-1"
                            disabled>Save</button> -->
                    </div>

                    <div class="row mx-2 my-1 p-1">
                        <button id="eraseMaskBtn" type="button" class="btn btn-warning col-12" disabled>Erase
                            Current</button>
                    </div>

                    <div class="row mx-2 my-1 p-1">
                        <button id="finishedMaskBtn" type="button" class="btn btn-primary col-12 ml-1"
                            disabled>Save</button>
                    </div>

                    <div class="row md-8 mx-2 p-1">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th scope="col">Name</th>
                                    <th scope="col">Interpolated</th>
                                    <th scope="col">Date</th>
                                    <th scope="col">User</th>
                                    <!--<th scope="col"></th> -->
                                </tr>
                            </thead>
                            <tbody id="maskTbody">
                            </tbody>
                        </table>
                    </div>

                    <div class="row mx-2 my-1 p-1">
                        <label class="mt-2" for="maskLoadInput">Mask Name</label>
                        <input id="maskLoadInput" type="text" class="form-control col-7 mx-1" disabled>
                        <!-- <button id="loadMaskBtn" type="button" class="btn btn-primary col-4" disabled>Load</button>
                        <p class="mb-1"></p> -->
                    </div>

                    <div class="row mx-2 my-1 p-1">
                        <!-- <label class="mt-2" for="maskLoadInput">Mask Name</label>
                        <input id="maskLoadInput" type="text" class="form-control col-4 mx-1" disabled> -->
                        <button id="loadMaskBtn" type="button" class="btn btn-primary col-12" disabled>Load</button>
                        <p class="mb-1"></p>
                    </div>
                </div>

                <div id="exportCard" class="card-body tab-pane">
                    <div class="row mx-1 my-1 p-1">
                        <label for="exportXYZSelect">Axis</label>
                        <select id="exportXYZSelect" class="form-control mx-1">
                            <option value="0" selected> XY </option>
                            <option value="1"> XZ </option>
                            <option value="2"> YZ </option>
                        </select>
                        <button id="exportBtn" class="btn btn-primary col-12" role="button" disabled>Export
                            Image</button>
                    </div>
                </div>


                <div id="fileCard" class="tab-pane">
                    <div class="modal-body" style="width: 400px; margin-left: -20px;">
                        <table class="table table-bordered sticky-header" style="width: 100%; table-layout: fixed;">
                            <thead>
                                <tr>
                                    <th scope="col" style="width: 120px;">File Name</th>
                                    <th scope="col" style="width: 60px;">Tag</th>
                                    <th scope="col">Tools</th>
                                </tr>
                            </thead>
                        </table>

                        <div style="max-height: 280px; overflow-y: auto;">
                            <table class="table table-bordered sticky-header" style="width: 100%; table-layout: fixed;">
                                <tbody id="fileMTbody">
                                    <!-- 表体内容 -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <div class="file-selector">
                            <div class="file-choose-container">
                                <button type="button" id="FileChooseBtn" class="btn btn-secondary"
                                    disabled>Choose</button>
                                <input type="text" id="file-name" placeholder="File Name" readonly class="form-control"
                                    style="width: 150px; margin-left: 5px;">
                                <input type="file" name="file" id="file-input" style="display: none;">
                                <button id="UploadFileBtn" type="button" style="margin-left: 5px;"
                                    class="btn btn-secondary" disabled>Upload</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="settingsCard" class="card-body tab-pane">
                    <div class="form-row form-check form-check-inline">
                        <!---
                            <label class="form-check-label ml-2" for="thresholdLockCheckbox">Threshold Lock:
                                <i class="fas fa-info-circle" data-toggle="popover" data-placement="top" title="Threshold Lock"
                                data-content="The 3D viewer will share the same threshold for removing artifacts from the 
                                images as the 2D viewer."></i>&nbsp;</label>
                            <input class="form-check-input" type="checkbox" id="thresholdLockCheckbox" checked>
                            -->
                    </div>
                </div>
            </div>
        </div>
        <div class="my-container">
            <div class="row">
                <div class="col-lg-12 col-md-6 ml-auto" style="height: 50%;">
                    <div class="d-flex justify-content-end">
                        <div id="UpMainDiv" style="width: 95%;">
                            <div class="card shadow">
                                <div class="card-header">
                                    <div class="d-flex flex-column">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <!-- Tab Navigation -->
                                            <ul class="nav nav-tabs flex-row d-none" id="myTabNav">
                                                <li class="nav-item">
                                                    <a id="orthoTab" class="nav-link px-2 disabled" data-toggle="tab"
                                                        href="#orthoCard">
                                                        Orthographic Views
                                                    </a>
                                                </li>
                                                <li class="nav-item">
                                                    <a id="vrTab" class="nav-link px-2 disabled" data-toggle="tab"
                                                        href="#vrCard">
                                                        Volume Rendering
                                                    </a>
                                                </li>
                                            </ul>
                                            <!-- Form Selection -->
                                            <form class="form d-flex align-items-center ml-auto">
                                                <div class="form-group d-flex align-items-center mx-2 my-0"
                                                    style="align-items: center;">
                                                    <label for="dsSelect" class="mr-1 align-self-center"
                                                        style="margin-bottom: 0;">Dataset:</label>
                                                    <select id="dsSelect" class="form-control form-control-sm"
                                                        style="width: 120px;">
                                                        <option value="" selected>Choose..</option>
                                                        {% for ds in datasets %}
                                                        <option value="{{ ds }}">{{ ds }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>

                                                <div class="form-group d-flex align-items-center mx-2 my-0"
                                                    style="align-items: center;">
                                                    <label for="modSelect" class="mr-1 align-self-center"
                                                        style="margin-bottom: 0;">Modality:</label>
                                                    <select id="modSelect"
                                                        class="form-control form-control-sm align-self-center"
                                                        style="width: 120px; height: calc(1.5em + .75rem + 2px);"
                                                        disabled></select>
                                                </div>

                                                <div class="form-group d-flex align-items-center mx-2 my-0"
                                                    style="align-items: center;">
                                                    <label for="exposureSelect" class="mr-1 align-self-center"
                                                        style="margin-bottom: 0;">Exposure:</label>
                                                    <select id="exposureSelect"
                                                        class="form-control form-control-sm align-self-center"
                                                        style="width: 120px; height: calc(1.5em + .75rem + 2px);"
                                                        disabled></select>
                                                </div>

                                                <div class="form-group d-flex align-items-center mx-2 my-0"
                                                    style="align-items: center;">
                                                    <label for="wavelengthSelect" class="mr-1 align-self-center"
                                                        style="margin-bottom: 0;">Wavelength:</label>
                                                    <select id="wavelengthSelect"
                                                        class="form-control form-control-sm align-self-center"
                                                        style="width: 120px; height: calc(1.5em + .75rem + 2px);"
                                                        disabled></select>
                                                </div>
                                            </form>
                                        </div>
                                        <!-- Information Display -->
                                        <div class="card mt-3 d-none" id="info">
                                            <div class="card-body py-2">
                                                <div class="d-flex flex-wrap align-items-center">
                                                    <div class="form-group mx-1 my-0 d-flex align-items-center">
                                                        <dt class="mr-1 small">Institution Name:</dt>
                                                        <dd id="InstitutionName" class="small mb-0"></dd>
                                                    </div>
                                                    <div class="form-group mx-1 my-0 d-flex align-items-center">
                                                        <dt class="mr-1 small">PI:</dt>
                                                        <dd id="piInfo" class="small mb-0"></dd>
                                                    </div>
                                                    <div class="form-group mx-1 my-0 d-flex align-items-center">
                                                        <dt class="mr-1 small">Specimen Name:</dt>
                                                        <dd id="specimenInfo" class="small mb-0"></dd>
                                                    </div>
                                                    <div class="form-group mx-1 my-0 d-flex align-items-center">
                                                        <dt class="mr-1 small">Voxel Size:</dt>
                                                        <dd id="voxelInfo" class="small mb-0"></dd>
                                                    </div>
                                                    <div class="form-group mx-1 my-0 d-flex align-items-center">
                                                        <dt class="mr-1 small">Section Thickness:</dt>
                                                        <dd id="thicknessInfo" class="small mb-0"></dd>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="xy-card-body" class="card-body d-none">
                                    <div id="xyDiv" style="cursor: crosshair;"><label
                                            style="display: block; text-align: center; font-weight: bold;">XY</label></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12 col-md-6 float-right" style="height: 50%;">
                    <div class="d-flex justify-content-end">
                        <div id="DownMainDiv" class="d-none" style="width: 95%;">
                            <div class="card shadow">
                                <div class="tab-content">
                                    <div id="orthoCard" class="card-body tab-pane active">
                                        <div style="display: flex;gap: 10px;">
                                            <div id="xzDiv" style="cursor: crosshair; flex: 1;">
                                                <label
                                                    style="display: block; text-align: center;font-weight: bold;">XZ</label>
                                            </div>

                                            <div id="yzDiv" style="cursor: crosshair; flex: 1;">
                                                <label
                                                    style="display: block; text-align: center;font-weight: bold;">YZ</label>
                                            </div>

                                        </div>
                                        <div id="orthoOverlayDiv"
                                            class="d-none justify-content-center align-items-center overlay">
                                            <div class="w-100 justify-content-center align-items-center">
                                                <div class="spinner"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="vrCard" class="card-body tab-pane">
                                        <div id="progressDiv" class="progress d-none">
                                            <div id="3dProgress" class="progress-bar" role="progressbar" style="width: 0%;"
                                                aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <div style="display: flex; justify-content: center; align-items: center;">
                                            <canvas id="c"></canvas>
                                        </div>
                                        <div id="toolbars" class="height: 160px">
                                            <form class="form-inline" onSubmit="return false;">
                                                <div class="form-group">
                                                    <label class="form-check-label mr-1" for="zLockCheckbox">Z Lock:
                                                        <i class="fas fa-info-circle d-none" data-toggle="popover"
                                                            data-placement="top" title="Z Lock"
                                                            data-content="The 3D viewer will clip at the Z slice selected in the 2D viewer"></i>&nbsp;</label>
                                                    <input class="form-check-input" type="checkbox" id="zLockCheckbox"
                                                        checked>

                                                </div>
                                                <div class="form-group">
                                                    <label for="zSliceInput">Z Clip:
                                                        <input class="form-check-input ml-1" type="checkbox"
                                                            id="clipZCheckbox" disabled>
                                                    </label>
                                                    <input id="zSliceInput" class="mx-1 form-control" step="1" type="number"
                                                        max="700" disabled>
                                                    <label for="ySliceInput">Y Clip:
                                                        <input class="form-check-input ml-1" type="checkbox"
                                                            id="clipYCheckbox" disabled>
                                                    </label>
                                                    <input id="ySliceInput" class="mx-1 form-control" step="4" type="number"
                                                        disabled>
                                                    <label for="ySliceInput">X Clip:
                                                        <input class="form-check-input ml-1" type="checkbox"
                                                            id="clipXCheckbox" disabled>
                                                    </label>
                                                    <input id="xSliceInput" class="mx-1 form-control" step="4" type="number"
                                                        disabled>
                                                </div>
                                                <div class="form-group">
                                                    <label for="shaderSelect">Shader</label>
                                                    <select id="shaderSelect" class="form-control ml-1">
                                                        <option value="2" selected> Surface </option>
                                                        <option value="0"> MIP </option>
                                                    </select>
                                                </div>
                                                <div class="form-group">
                                                    <label for="opacity" class="ml-1">Opacity</label>
                                                    <input type="range" class="ml-1" id="opacity" min="0" max="10" step=".1"
                                                        value="10">
                                                    <input class="form-check-input ml-1" type="checkbox" id="edgesCheckbox">
                                                    <label class="form-check-label ml-1" for="edgesCheckbox">Bounding
                                                        Box</label>
                                                    <button id="3dFullIconBtn" class="btn btn-primary" type="button"
                                                        disabled>
                                                        <i class="fas fa-expand"></i>&nbsp Fullscreen&nbsp3D
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                        <div id="vrOverlayDiv"
                                            class="d-none justify-content-center align-items-center overlay">
                                            <div class="w-100 justify-content-center align-items-center">
                                                <div class="spinner"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12 col-md-6 float-right" style="height: 50%;">
                    <div class="d-flex justify-content-end">
                        <div id="DownToolDiv" class="d-none" style="width: 95%;">
                            <div class="card shadow">
                                <div class="row h-100" style="display: flex;">
                                    <form id="xyForm" class="form-inline d-flex justify-content-between" style="flex: 3;"
                                        onSubmit="return false;">
                                        <div class="d-flex">
                                            <div id="arrowControls" class="form-group mb-2 d-flex justify-content-center"
                                                style="flex: 4; margin-left: 20px;">
                                                <button id="stepBackBtn" class="cust-full" type="button" disabled><i
                                                        class="mx-1 fa-lg fas fa-step-backward"></i></button>
                                                <button id="backBtn" class="cust-full" type="button" disabled><i
                                                        class="mx-1 fa-lg fas fa-arrow-left"></i></button>
                                                <button id="forwardBtn" class="cust-full" type="button" disabled><i
                                                        class="mx-1 fa-lg fas fa-arrow-right"></i></button>
                                                <button id="stepForwardBtn" class="cust-full" type="button" disabled><i
                                                        class="mx-1 fa-lg fas fa-step-forward"></i></button>
                                            </div>

                                            <div id="sliceDiv" class="form-group mb-2 d-flex align-items-center">
                                                <label for="sliceInput" class="mb-0" style="margin-right: 10px;">Slice
                                                    Navigator:</label>
                                                <input id="sliceInput" class="form-control" type="number" max="700"
                                                    disabled>
                                            </div>

                                            <div id="sliderDiv" class="form-group mb-2" style="flex: 2; margin-left: 20px;">
                                                <input id="sliceRange" class="form-control-range mt-3" type="range"
                                                    disabled>
                                            </div>
                                        </div>

                                        <div class="form d-flex align-items-center ml-auto"
                                            style="flex: 2; min-width: 600px;">
                                            <select id="FullScreenSelect"
                                                class="form-control d-flex align-items-center mx-2 my-0 ml-auto">
                                                <option value="0" selected>XY</option>
                                                <option value="1">XZ</option>
                                                <option value="2">YZ</option>
                                            </select>
                                            <button id="FullScreenBtn" class="btn btn-primary" type="button" disabled
                                                style="width: 25%; margin-right: 40px;">
                                                <i class="fas fa-expand"></i> FullScreen
                                            </button>
                                        </div>

                                    </form>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
</div>

<div class="container-fluid d-none">
    <div class="row col-12 px-0 float-left">
        <div class="col-10 mt-3" style="width: 100%;">
            <div class="card shadow">
            </div>
        </div>
        <div class="col-2 float-right ml-0 mt-3">
            <div class="card shadow">
                <div class="card-header pt-1">
                    <ul class="nav nav-tabs card-header-tabs">
                        <li class="nav-item">
                            <a class="nav-link active px-2" data-toggle="tab" href="#mainCard">Main</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link px-2" data-toggle="tab" href="#optCard">Options</a>
                        </li>
                    </ul>
                </div>
                <div class="tab-content">
                    <div id="mainCard" class="card-body tab-pane active">
                        <button id="visBtn" class="btn btn-primary btn-block" type="button" disabled>3D on</button><br>
                        <button id="3dFullIcon" class="cust-full" type="button"><i class="fas fa-expand"></i>&nbsp
                            Fullscreen</button>

                        <br>
                        <label for="threshold" class="mb-0">Threshold</label>
                        <input type="range" id="threshold" min="0" max="3" step=".05" value=".55">
                        <small>Background Color</small>
                        <div class="pickr" id="bg"></div>

                    </div>
                    <div id="optCard" class="card-body tab-pane">
                        <div class="form-row form-check form-check-inline">
                            <label for="cellModal">Stem Cells
                                <input class="form-check-input" type="checkbox" id="cellModalBox">
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <canvas id="pixelHolder" class="d-none"></canvas>
        <button id="dsBtnEvent" class="d-none" role="button"></button>
    </div>
</div>
<div class="container-fluid">
    <div class="modal fade" id="annotationModal" tabindex="-1" role="dialog" aria-labelledby="annotationModal"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Annotation</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input id="annModalTxt" class="form-control" type="text"
                        onkeyup="this.value = this.value.replace(/[-]/g, '')">
                    <input id="annModalOldTxt" class="form-control" type="text" hidden>
                    <input id="annModalInstance" class="form-control" type="text" disabled>
                    <div class="form-group">
                        <label for="annModalComments">Additional Comments</label>
                        <textarea class="form-control" id="annModalComments" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="annModalSave" type="button" class="btn btn-secondary">Save</button>
                    <button id="annModalDelete" type="button" class="btn btn-secondary btn-danger">Delete</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="modal fade" id="contentFiledownload" tabindex="-1" role="dialog" aria-labelledby="contentModal"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="width: 140% !important; height: 400px !important;">
                <div class="modal-header">
                    <h5 id="contentFileTitle" class="modal-title">File download</h5>
                </div>

                <div class="modal-body">
                    <div style="overflow: scroll; max-height: 200px;">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th scope="col"> </th>
                                    <th scope="col">File Name</th>
                                    <th scope="col">Tag</th>
                                    <th scope="col">Tools</th>
                            </thead>
                            <tbody id="fileTbody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="downloadFileBtn" type="button" class="btn btn-primary">Download</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade always-on-top" id="filePreviewModal" tabindex="-1" role="dialog"
    aria-labelledby="filePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content" style="
        width: 600px;
        height: 500px;
    ">
            <div class="modal-header">
                <h5 class="modal-title" id="file-info"></h5>
            </div>
            <div class="modal-body">
                <div id="file-preview-container">
                    <div id="file-contents"></div>
                    <pre id="file-preview"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade always-on-top" id="imagePreviewModal" tabindex="-1" role="dialog"
    aria-labelledby="imagePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imagePreviewModalLabel">Image Preview</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="image-preview"></div>
            </div>
            <div class="modal-footer">
                <div id="image-info"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade always-on-top" id="videoPreviewModal" tabindex="-1" role="dialog"
    aria-labelledby="videoPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="video-info"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <video id="video-preview" width="100%" height="auto" controls></video>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="viewDetailModal" tabindex="-1" role="dialog" aria-labelledby="viewDetailModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewDetailModalLabel">View Detail</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="detail-section">
                    <p><strong>View Name:</strong> <span id="viewNameDetail"></span></p>
                    <p><strong>Creator:</strong> <span id="viewCreatorDetail"></span></p>
                    <p><strong>Overall Load Times:</strong> <span id="loadtimesDetail"></span></p>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="thead-dark">
                            <tr>
                                <th scope="col">User</th>
                                <th scope="col">Load Times</th>
                                <th scope="col">Last Time Load</th>
                            </tr>
                        </thead>
                        <tbody id="viewDetailsTableBody">
                            
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<script>
    //Globals (shared between 2D and 3D)
    dsInfo = ''
    pickr2 = ''
    let clipCoords = { x: -1, y: -1, z: -1 }
    let zLockBox = document.getElementById("zLockCheckbox"),
        zclip = document.getElementById("zSliceInput")
    let yclip = document.getElementById("ySliceInput")
    let xclip = document.getElementById("xSliceInput")
    let threshold = document.getElementById("threshold")
    let threshold2D = document.getElementById("threshold2D"),
        thresholdBox = document.getElementById("thresholdLockCheckbox")
    let clipXCheckbox = document.getElementById("clipXCheckbox")
    let clipYCheckbox = document.getElementById("clipYCheckbox")
    let clipZCheckbox = document.getElementById("clipZCheckbox")
    let modSelect = document.getElementById("modSelect"),
        exposureSelect = document.getElementById("exposureSelect"),
        wavelengthSelect = document.getElementById("wavelengthSelect")
    //TODO page resize should update this
    let vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0)
</script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.5.0/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip-utils@0.0.2/dist/jszip-utils.min.js"></script>
<!-- In house scripts -->
<script type="module" src="/static/js/twoBIV.js"></script>
<!-- version 100 MIP shader but THREE translates it to 300-->
<script src="./static/js/orthogonal-shader.js"></script>
<script src="./static/js/cellDensityShader.js"></script>
<!-- 3D rendering-->
<script type="module" src="/static/js/threeBIV.js"></script>
<script>


    //var pickr, pickr2, pickrCreated = false
    $(function () {
        $('[data-toggle="popover"]').popover({
            trigger: 'hover'
        })

        document.addEventListener('focus', (e) => {
            console.log(e)
        })

        //document.getElementById('imageTab').addEventListener('click', () => {
        /*
        window.addEventListener("DOMContentLoaded", () => {
        pickrCreated = true
        pickr = Pickr.create({
        el: '#bg',
        theme: 'nano', // or 'monolith', or 'nano'
        default: 'rgba(255, 0, 0, 1)',
        swatches: [
            'rgba(244, 67, 54, 1)',
            'rgba(255, 255, 224, 1)',
            'rgba(233, 30, 99, 0.95)',
            'rgba(156, 39, 176, 0.9)',
            'rgba(103, 58, 183, 0.85)',
            'rgba(63, 81, 181, 0.8)',
            'rgba(33, 150, 243, 0.75)',
            'rgba(3, 169, 244, 0.7)',
            'rgba(0, 188, 212, 0.7)',
            'rgba(0, 150, 136, 0.75)',
            'rgba(76, 175, 80, 0.8)',
            'rgba(139, 195, 74, 0.85)',
            'rgba(205, 220, 57, 0.9)',
            'rgba(255, 235, 59, 0.95)',
            'rgba(255, 193, 7, 1)'
        ],
 
        components: {
 
            // Main components
            preview: true,
            opacity: true,
            hue: true,
 
            // Input / output Options
            interaction: {
                clear: true,
                save: true
            }
        }
        }).on('save', () => { 
            
            
            pickr.hide() 
        }).on('hide', () => {
            console.log('NOT WORKING') 
            let pickrs = document.getElementsByClassName('pcr-button')
            for ( let i=0; i<pickrs.length; i++)
                pickrs.style.color = "rgba(250,0,0,1)"
        
 
        })
    })*/
    })

</script>
<!-- Basis vert shader-->
<script id="vertex_shader" type="x-shader/x-vertex">

varying vec2 vUv;

void main() {
    vUv = uv;
    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
    
}

</script>
<!-- Basis frag shader-->
<script id="fragment_shader" type="x-shader/x-fragment">

uniform sampler2D u_texture;
uniform float u_threshold;
uniform float u_mod;
varying vec2 vUv;

void main() {
    
    vec4 tColor = texture( u_texture, vUv ).rgba;
    float fauxAlpha = abs( tColor.r - tColor.g);
    if (u_mod == 1.0) fauxAlpha =  abs(tColor.g - tColor.b);
    if ( tColor.a == 0.)
        gl_FragColor = vec4(0.,0.,0.,0.);
    else if ( fauxAlpha < u_threshold)
        gl_FragColor = vec4(0.,0.,0.,0.);
    else gl_FragColor = tColor;
    
}
</script>


<script>
    function toggleNav() {
        var mySidebar = document.getElementById("mySidebar");
        if (mySidebar.classList.contains("show")) {
            mySidebar.classList.remove("show");
        } else {
            mySidebar.classList.add("show");
        }
    }
</script>
{% endblock %}